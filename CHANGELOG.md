# 更新日志 (CHANGELOG)


## [v4.6.6] - fix(pdf): 迁移为 playwright

*   **🛠️ 健壮性增强**: 使用更好用的 playwright 避免 pdf 生成期间无法预测的行为。

---

<details>
<summary>📋 点击查看历史更新日志</summary>

## [v4.6.5] - feat(ReportGenerator): 优化 t2i 参数

*   **🛠️ 健壮性增强**: ReportGenerator 优化 t2i 参数，增加设备缩放因子。生成的报告图片更加清晰。

## [v4.6.4] - 重试管理器优化和业务逻辑调整

*   **🛠️ 健壮性增强**: 重试管理器直接从渲染器请求原始图像字节，QQ 客户端不再需要从本地服务器下载图片，从而绕过了导致超时的网络传输层。
*   **🐛 Bug 修复**: 解决手动群分析命令在 NTQQ 内核尝试上传图片并将其推送到腾讯服务器时，超过了预设的时间限制（通常是 120 毫秒或更久），导致连接断开。的 aiocqhttp.exceptions.ActionFailed 问题

## [v4.6.3] - 默认模板 scrapbook 的 activity_chart 排版调整为横向

*   **🎨 样式优化**: activity_chart 排版调整为横向，减小没有实质内容的 activity_chart 对排版的空间占用。

## [v4.6.2] - 新增图片报告重试机制并优化调度稳定性

*   **✨ 新功能**: 新增图片报告重试机制并优化调度稳定性，实现延迟队列与死信队列，支持指数退避 + 随机抖动 (Jitter) 重试策略。


## [v4.6.1] - Linux 下的 `/安装PDF` 指令简易修复，纠正头像获取的处理；PDF 格式在 Linux 环境下占用过大，原因还在排查中，暂时不推荐使用。

*   **🐛 Bug 修复**: 修复 generators.py 中 _get_user_avatar 的 TypeError。将 aiohttp 请求重构为异步上下文模式，确保 response.read() 被正确等待，并增加了网络连接失败处理。
*   **🐛 Bug 修复**: Linux 环境下的安装 PDF 命令修复，调整 PDF 格式排版情况。PDF 格式在 Linux 环境下占用过大，原因还在排查中，暂时不推荐使用。

## [v4.6.0] - 通过 AstrBot 配置文件来判断账号启用插件

*   **🐛 Bug 修复**: 检查该平台是否包含该插件的配置文件 plugin_set，通过 AstrBot 配置文件来判断账号启用插件。


## [v4.5.8] - 群贤毕至添加头像

*   **✨ 新功能**: "群贤毕至"板块新增用户头像显示，提升视觉体验。

---

## [v4.5.7] - 文档与描述调整

*   **✨ 体验优化**: 调整了 Scrapbook 模板页脚关于 Token 消耗的描述文本。
*   **📕 文档更新**: 更新了插件元数据中的仓库地址。

---

## [v4.5.6] - 模板排版优化

*   **🎨 样式优化**: 优化了 Scrapbook 报告模板的排版和布局细节。

---

## [v4.5.5] - 性能与并发优化

*   **🛠️ 健壮性增强**: 修复了 `Jinja2` 模板渲染时的线程安全问题，防止并发渲染错误。
*   **⚡ 性能优化**: 将统计和分析等 CPU 密集型计算任务卸载到独立线程池执行，避免阻塞主事件循环。

---

## [v4.5.4] - 市场元数据更新

*   **📚 文档更新**: 更新插件 `metadata` 描述并重新提交至插件市场，优化用户搜索体验。

---

## [v4.5.2] - 模板指令增强

*   **✨ 新功能**: 新增 `/查看模板` 指令，以合并转发消息的形式预览所有可用模板。
*   **💻 交互优化**: `/设置模板` 指令现支持通过序号直接选择模板，操作更便捷 (@clown145)。

---

## [v4.5.0] - 新主题与调试工具

*   **✨ 新增主题**: 添加 `retro_futurism` (未来复古主义) 主题模板，致敬《明日方舟》孤星活动美术风格。
*   **🛠️ 开发者工具**: 新增 `scripts/debug_render.py` 脚本，支持在不启动 AstrBot 的情况下独立调试渲染效果 (@Saramanda9988)。

---

## [v4.4.0] - 图片发送机制增强

*   **🛡️ 健壮性增强**: 优化图片发送逻辑，在直接发送失败时回退尝试使用 BASE64 编码发送，提高发送成功率 (@Heximiao)。

---

## [v4.3.0] - 样式清理修复

*   **🐛 Bug 修复**: 修复了关闭特定分析区后，其基础样式代码未正确清理的问题。

---

## [v4.2.0] - 适配 AstrBot 新标准

*   **🔌 核心适配**: 适配 **AstrBot v4.5.7+** 的最新 LLM API 标准。
*   **✨ 新功能**: 支持多套主题模板切换机制，为后续更多模板打下基础。

---

## [v4.1.0] - 黑白名单与并发锁

*   **✨ 新功能**: 引入群聊分析黑白名单机制，精细化控制启用范围。
*   **⚡ 性能优化**: 使用信号量 (`Semaphore`) 限制并发，并采用弱引用字典 (`WeakValueDictionary`) 优化锁管理，降低内存占用。

---

## [v4.0.0] - 全新 Scrapbook 模板

*   **🎨 重大更新**: 推出全新设计的 "Scrapbook" (手账) 风格报告模板！
    *   灵感源自 GalGame 《五彩斑斓的世界》，模拟二阶堂真红和悠马的日记风格。
    *   卡通手账排版，带来温馨治愈的视觉体验。

---

## [v3.9.5] - 模板引擎迁移

*   **🔧 技术重构**: 将报告生成迁移至 `Jinja2` 模板引擎，HTML 模板文件分离，大幅降低调试和修改难度。

---

## [v3.9.0] - 自动化发版流程

*   **👷 工程化**: 引入自动发版 GitHub Action 和 Issue 模板，规范开发流程 (感谢 @lxfight 参考 Mnemosyne-AstrBot 插件实现)。

---

## [v3.8.0] - 多账号/多适配器支持

*   **✨ 新功能**: 适配多适配器实例，支持配置多个 QQ 账号。
*   **⚙️ 配置增强**: 支持在群分析中排除特定的机器人 QQ 号或多平台账号。
*   **🐛 Bug 修复**: 修复多适配器环境下 Bot 实例与平台 ID 的映射问题，确保消息获取和报告发送正确路由。

---

## [v3.7.0] - Provider 多级回退

*   **🛡️ 健壮性增强**: 实现了 LLM Provider 的多级回退机制，确保服务高可用：
    1. 配置指定的 Provider。
    2. 回退到主 LLM Provider。
    3. 回退到当前会话 Provider。
    4. 回退到任意可用 Provider。

---

## [v3.6.0] - 消息获取策略调整

*   **🔧 功能调整**: 鉴于 NapCat 存在的问题，移除了分页拉取和多次轮询逻辑，以此解决消息数量获取异常的 Bug (@exynos967)。

---

## [v3.5.0] - Token 控制

*   **⚡ 性能优化**: 优化了 `max_tokens` 参数处理，并自动过滤机器人自身发送的消息，节省 Token 消耗。

---

## [v3.4.1] - 配置项迁移保护

*   **🔧 维护性**: 更新配置文件键名，防止因旧版本 (v3.3.0/v3.2.0) 的错误提示词配置导致插件异常。

---

## [v3.4.0] - 提示词兼容性

*   **🐛 Bug 修复**: 简单修复自定义提示词模板的格式问题，保证基本可用性。

---

## [v3.3.0] - 历史消息机制修复

*   **🐛 Bug 修复**: 修复自动分析获取历史消息不严谨的问题（如超出当天范围或数量限制失效）。

---

## [v3.2.0] - 自定义提示词

*   **✨ 新功能**: 开放自定义提示词模板配置，允许用户根据群聊特点定制分析 Prompt。

---

## [v3.1.0] - 异步分析优化

*   **⚡ 性能优化**: 将 LLM 话题分析的三部分串行请求改为异步并发执行，显著缩短分析耗时。

---

## [v3.0.0] - 自动分析修复

*   **🐛 Bug 修复**: 解决了自动分析器在特定情况下无法获取群聊消息的严重 Bug。

---

## [v2.9.0] - 异步 PDF 安装

*   **⚡ 性能优化**: PDF 依赖安装过程不再阻塞主线程。

---

## [v2.8.0] - 群昵称偏好

*   **✨ 新功能**: 支持在配置中启用 "偏好使用群昵称" 选项 (@Ri-Nai)。

---

## [v2.7.0] - JSON 提取增强

*   **🛡️ 健壮性增强**: 增强了对 LLM 输出 JSON 格式的提取和容错能力。

---

## [v2.6.0] - 日期处理修正

*   **🐛 Bug 修复**: 纠正了自动分析处理逻辑中的日期计算错误。

---

## [v2.5.0] - 自动分析并发

*   **⚡ 性能优化**: 实现了自动分析器的群聊并发处理。
*   **🐛 Bug 修复**: 解决了自动分析器实例不唯一的问题。

---

## [v2.4.0] - 模型获取修复

*   **🐛 Bug 修复**: 修复了无法正确获取当前使用模型名称的问题。

---

## [v2.3.0] - 定时触发修复

*   **🐛 Bug 修复**: 修复了定时触发自动分析时无法获取 Bot 实例的问题（现需传入 Bot QQ 号）。

---

## [v2.2.0] - 图片清晰度优化

*   **🎨 样式优化**: 提高了生成的图片报告清晰度，微调了字体大小（排版待进一步重构）。

---

## [v2.1.0] - 自定义模型配置

*   **⚙️ 配置增强**: 支持自定义 Provider 或留空，支持配置自定义模型的重试次数和超时时间。

---

## [v1.9.0] - 24h 活跃度分析

*   **✨ 新功能**: 新增 24 小时活跃度分布图表分析。

---

## [v1.8.0] - 表情统计修复

*   **🐛 Bug 修复**: 修正了表情使用统计数据不准确的问题。

---

## [v1.7.0] - 解耦与提示优化

*   **🔧 代码重构**: 核心代码解耦化，并优化了部分用户提示。

---

## [v1.4.0] - PDF 说明更新

*   **📖 文档更新**: 更新了关于 PDF 版本功能的说明文档。

---

## [v1.3.0] - Token 消耗说明

*   **📖 文档更新**: 增加了关于 Token 消耗情况的说明。

---

## [v1.2.0] - 提示词规范化

*   **🛡️ 健壮性增强**: 规范了 LLM 话题分析的提示词，并引入正则处理以提高解析成功率。

---

## [v1.1.0] - 权限与定时任务

*   **🛡️ 安全性**: 优化权限控制，管理员可管控大部分命令以防 Token 滥用。
*   **✨ 新功能**: 新增定时自动触发群分析功能。
*   **✨ 新功能**: 支持发送 PDF 版报告推送（可选配置）。
*   **🐛 Bug 修复**: 修复了若干已知小问题。

---

## [v1.0.0] - 初始版本

*   **🎉 发布**: 插件初始版本发布。
*   **✨ 功能列表**:
    *   基础群聊数据分析。
    *   智能话题总结与用户称号生成。
    *   精美可视化报告生成。

</details>
